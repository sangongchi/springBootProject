# 日志配置说明文档

## 一、配置文件说明

本项目使用两种方式配置日志：
1. **application-dev.properties** - Spring Boot 属性配置（简单配置）
2. **logback-spring.xml** - Logback 详细配置（推荐，功能更强大）

## 二、application-dev.properties 配置字段说明

### 2.1 日志级别配置

```properties
# 全局日志级别
logging.level.root=INFO
```
- **作用**：设置根日志记录器的级别，所有未单独配置的包都使用此级别
- **可选值**：TRACE < DEBUG < INFO < WARN < ERROR < FATAL < OFF
- **说明**：
  - TRACE：最详细的日志，通常只在开发时使用
  - DEBUG：调试信息，开发环境常用
  - INFO：一般信息，生产环境常用
  - WARN：警告信息
  - ERROR：错误信息
  - FATAL：严重错误
  - OFF：关闭日志

```properties
# 指定包的日志级别
logging.level.com.baomidou.mybatisplus=DEBUG
logging.level.org.mybatis=DEBUG
logging.level.java.sql=DEBUG
```
- **作用**：为特定包设置日志级别，优先级高于 root 级别
- **说明**：可以针对不同的包设置不同的日志级别，便于调试和排查问题

### 2.2 日志文件输出配置

```properties
# 日志文件路径
logging.file.name=logs/application.log
```
- **作用**：指定日志文件的完整路径（包括文件名）
- **说明**：
  - 相对路径：相对于项目根目录或工作目录
  - 绝对路径：如 `E:/logs/application.log`
  - 如果不设置，日志只输出到控制台

```properties
# 日志文件目录（与 logging.file.name 二选一）
logging.file.path=logs
```
- **作用**：指定日志文件目录，文件名默认为 `spring.log`
- **说明**：如果同时设置了 `logging.file.name` 和 `logging.file.path`，`logging.file.name` 优先级更高

```properties
# 日志文件编码
logging.file.encoding=UTF-8
```
- **作用**：设置日志文件的字符编码
- **说明**：建议使用 UTF-8，避免中文乱码

### 2.3 日志格式配置

```properties
# 控制台日志格式
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n
```
- **作用**：定义控制台输出的日志格式
- **格式说明**：
  - `%d{yyyy-MM-dd HH:mm:ss.SSS}`：日期时间，精确到毫秒
  - `%thread`：线程名
  - `%-5level`：日志级别（左对齐，5个字符宽度）
  - `%logger{50}`：日志记录器名称（最多50个字符）
  - `%msg`：日志消息
  - `%n`：换行符

```properties
# 文件日志格式
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n
```
- **作用**：定义文件输出的日志格式
- **说明**：可以与控制台格式不同，文件格式可以更详细

### 2.4 日志文件滚动策略

```properties
# 单个日志文件最大大小
logging.logback.rollingpolicy.max-file-size=10MB
```
- **作用**：当单个日志文件达到此大小时，会创建新文件
- **单位**：支持 KB、MB、GB
- **说明**：防止单个日志文件过大，便于查看和管理

```properties
# 日志文件保留的最大总大小
logging.logback.rollingpolicy.total-size-cap=1GB
```
- **作用**：所有日志文件的总大小限制
- **说明**：超过此限制时，会删除最旧的日志文件

```properties
# 保留的日志文件数量
logging.logback.rollingpolicy.max-history=30
```
- **作用**：保留最近 N 天的日志文件
- **说明**：超过此天数的日志文件会被自动删除

```properties
# 日志文件命名模式
logging.logback.rollingpolicy.file-name-pattern=logs/application-%d{yyyy-MM-dd}-%i.log
```
- **作用**：定义滚动后的日志文件命名规则
- **说明**：
  - `%d{yyyy-MM-dd}`：按日期命名
  - `%i`：文件索引（当同一天的文件超过大小限制时使用）

## 三、logback-spring.xml 配置说明

### 3.1 文件结构

logback-spring.xml 提供了更强大的日志配置功能，包括：
- 多个日志文件输出（应用日志、操作日志、SQL日志、错误日志）
- 不同环境的配置（dev、prod）
- 更灵活的日志过滤和路由

### 3.2 主要配置项

#### Appender（日志输出器）

1. **CONSOLE** - 控制台输出
   - 输出到控制台
   - 开发环境常用

2. **FILE** - 应用日志文件
   - 输出到 `logs/ProjectBySpringBoot.log`
   - 按日期和大小滚动
   - 保留30天，总大小限制1GB

3. **OPERATION_FILE** - 操作日志文件
   - 输出到 `logs/operation.log`
   - 专门用于记录用户操作、API调用等
   - 保留90天，总大小限制500MB

4. **SQL_FILE** - SQL日志文件
   - 输出到 `logs/sql.log`
   - 专门用于记录SQL相关日志
   - 保留30天，总大小限制500MB

5. **ERROR_FILE** - 错误日志文件
   - 输出到 `logs/error.log`
   - 只记录 ERROR 级别的日志
   - 保留90天，总大小限制500MB

#### Logger（日志记录器）

```xml
<logger name="OPERATION" level="INFO" additivity="false">
```
- **name**：Logger 名称，代码中使用 `LoggerFactory.getLogger("OPERATION")` 获取
- **level**：日志级别
- **additivity="false"**：不继承 root logger，避免重复输出

### 3.3 环境配置

```xml
<springProfile name="dev">
    <!-- 开发环境配置 -->
</springProfile>

<springProfile name="prod">
    <!-- 生产环境配置 -->
</springProfile>
```
- **作用**：根据 Spring Profile 使用不同的日志配置
- **说明**：开发环境可以输出更多调试信息，生产环境只记录重要日志

## 四、操作日志使用说明

### 4.1 使用 OperationLogUtil 工具类

```java
import org.sangongchi.projectbyspringboot.utils.OperationLogUtil;
import jakarta.servlet.http.HttpServletRequest;

// 1. 记录用户操作
OperationLogUtil.logUserOperation(
    "user123",           // 用户ID
    "登录",              // 操作类型
    "用户管理",          // 模块
    "用户登录系统",      // 描述
    request              // HttpServletRequest（可选）
);

// 2. 记录API调用
Map<String, Object> params = new HashMap<>();
params.put("userId", 123);
OperationLogUtil.logApiCall(
    "获取用户信息",      // API名称
    "GET",               // HTTP方法
    "/user/123",         // URL
    params,              // 请求参数
    150,                 // 响应时间（毫秒）
    "成功"               // 状态
);

// 3. 记录业务操作
OperationLogUtil.logBusinessOperation(
    "订单管理",          // 业务类型
    "ORDER001",          // 业务ID
    "创建订单",          // 操作
    "admin",             // 操作人
    "创建了订单，金额：100元"  // 详情
);

// 4. 简单日志
OperationLogUtil.log("这是一条操作日志");

// 5. 带级别的日志
OperationLogUtil.log("WARN", "这是一条警告日志");
```

### 4.2 在 Controller 中使用示例

```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    @PostMapping
    public R<String> addUser(@RequestBody User user, HttpServletRequest request) {
        long startTime = System.currentTimeMillis();
        
        try {
            if (userService.addUser(user) > 0) {
                // 记录操作日志
                OperationLogUtil.logUserOperation(
                    "admin", 
                    "新增", 
                    "用户管理", 
                    "新增用户：" + user.getName(), 
                    request
                );
                
                return R.ok("添加成功");
            }
            return R.fail(500, "添加失败");
        } finally {
            // 记录API调用日志
            long responseTime = System.currentTimeMillis() - startTime;
            OperationLogUtil.logApiCall(
                "新增用户",
                "POST",
                "/user",
                Map.of("name", user.getName()),
                responseTime,
                "成功"
            );
        }
    }
}
```

### 4.3 直接使用 Logger

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class YourClass {
    // 获取操作日志记录器（名称必须与 logback-spring.xml 中的 logger name 一致）
    private static final Logger operationLogger = LoggerFactory.getLogger("OPERATION");
    
    public void someMethod() {
        operationLogger.info("这是一条操作日志");
        operationLogger.warn("这是一条警告日志");
        operationLogger.error("这是一条错误日志");
    }
}
```

## 五、日志文件位置

配置完成后，日志文件会生成在项目根目录的 `logs` 文件夹下：

```
logs/
├── ProjectBySpringBoot.log          # 应用主日志
├── ProjectBySpringBoot-2024-01-15-0.log  # 滚动后的日志
├── operation.log                     # 操作日志
├── operation-2024-01-15-0.log       # 滚动后的操作日志
├── sql.log                          # SQL日志
├── sql-2024-01-15-0.log            # 滚动后的SQL日志
├── error.log                        # 错误日志
└── error-2024-01-15-0.log          # 滚动后的错误日志
```

## 六、配置优先级

1. **logback-spring.xml** 优先级最高（如果存在）
2. **application.properties** 中的日志配置
3. Spring Boot 默认配置

## 七、注意事项

1. **日志文件路径**：确保应用有权限在指定路径创建和写入文件
2. **日志级别**：生产环境建议使用 INFO 级别，避免输出过多调试信息
3. **日志文件大小**：根据实际需求调整文件大小和保留策略
4. **磁盘空间**：定期清理过期日志，避免占用过多磁盘空间
5. **性能影响**：过多的日志输出可能影响应用性能，建议合理设置日志级别

## 八、常见问题

### Q1: 日志文件没有生成？
- 检查日志文件路径是否正确
- 检查应用是否有写入权限
- 检查日志级别是否设置正确

### Q2: 日志文件过大？
- 调整 `max-file-size` 参数
- 调整 `max-history` 参数，减少保留天数
- 调整 `total-size-cap` 参数，限制总大小

### Q3: 如何查看操作日志？
- 操作日志单独记录在 `logs/operation.log` 文件中
- 可以使用文本编辑器或日志查看工具打开

### Q4: 如何在不同环境使用不同配置？
- 使用 `logback-spring.xml` 中的 `<springProfile>` 标签
- 或者在对应的 `application-{profile}.properties` 中配置

